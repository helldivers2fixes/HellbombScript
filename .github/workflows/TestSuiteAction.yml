name: Hellbomb Script Cross-platform PowerShell Test Suite

on:
  push:
    branches: [ main ]
    paths:
      - "Hellbomb Script.ps1"
  pull_request:
    branches: [ main ]
    paths:
      - "Hellbomb Script.ps1"
  workflow_dispatch:

jobs:
  # --- JOB 1: NATIVE WINDOWS ---
  test-windows:
    name: Native Windows PS (5.1)
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Cache Pester (Windows)
        id: cache-win
        uses: actions/cache@v4
        with:
          path: '~\Documents\WindowsPowerShell\Modules'
          key: windows-pester-v1

      - name: Install Pester
        if: steps.cache-win.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name Pester -Force -SkipPublisherCheck -Scope CurrentUser

      - name: Run Pester Tests
        shell: powershell
        continue-on-error: true
        run: |
          $config = [PesterConfiguration]::Default
          $config.Run.Path = "./HellbombScript.Tests.ps1"
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = "pester-win.xml"
          $config.TestResult.OutputFormat = "NUnitXml"
          Invoke-Pester -Configuration $config

      - name: Generate Report
        uses: zyborg/pester-tests-report@v1.5.0
        if: always()
        with:
          test_results_path: pester-win.xml
          report_name: Windows_Results
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tests_fail_step: true

  # --- JOB 2: UBUNTU CORE ---
  test-ubuntu:
    name: Ubuntu PowerShell Core
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Cache Pester (Ubuntu)
        id: cache-ubuntu
        uses: actions/cache@v4
        with:
          path: '~/.local/share/powershell/Modules'
          key: ubuntu-pester-v1

      - name: Install Pester
        if: steps.cache-ubuntu.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name Pester -Force -SkipPublisherCheck -Scope CurrentUser

      - name: Run Pester Tests
        shell: pwsh
        continue-on-error: true
        run: |
          $config = [PesterConfiguration]::Default
          $config.Run.Path = "./HellbombScript.Tests.ps1"
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = "pester-ubuntu.xml"
          $config.TestResult.OutputFormat = "NUnitXml"
          Invoke-Pester -Configuration $config

      - name: Generate Report
        uses: zyborg/pester-tests-report@v1.5.0
        if: always()
        with:
          test_results_path: pester-ubuntu.xml
          report_name: Ubuntu_Results
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tests_fail_step: true
