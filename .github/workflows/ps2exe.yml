name: Build Hellbomb Script EXE & Update Hashes

permissions:
  contents: write
  pull-requests: write

on:
  push:
    branches: [ main ]

env:
  PS1_SCRIPT_NAME: "Hellbomb Script.ps1"

jobs:
  build-exe:
    runs-on: windows-latest
    outputs:
      exe_filename: ${{ steps.vars.outputs.filename }}
      exe_hash: ${{ steps.hash.outputs.exe_sha256 }}
      ps1_hash: ${{ steps.hash.outputs.ps1_sha256 }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Calculate Version & Filenames
        id: vars
        shell: pwsh
        run: |
          # 1. Get Version from Script Content
          $content = Get-Content -Path $env:PS1_SCRIPT_NAME -Raw
          if ($content -match '\|\|\s+Version\s+(\d\.\d+)') {
            $version = $matches[1]
          } else {
            Throw "Could not find version number in script."
          }

          # 2. Construct Filenames
          $shortSha = "${{ github.sha }}".Substring(0, 7)
          $finalName = "Hellbomb_Script_v${version}-${shortSha}-signed.exe"

          Write-Output "filename=$finalName" >> $env:GITHUB_OUTPUT
          Write-Output "version=$version"    >> $env:GITHUB_OUTPUT
          
          Write-Host "Target Filename: $finalName"

      - name: Cache Final EXE
        id: cache-exe
        uses: actions/cache@v4
        with:
          path: ./output
          # Cache key is based on the content of the PS1 script. 
          # If script changes -> Hash changes -> Cache Miss -> Rebuild.
          key: hellbomb-signed-v1-${{ steps.vars.outputs.version }}-${{ hashFiles('Hellbomb Script.ps1') }}

      - name: Build & Sign (Only on Cache Miss)
        if: steps.cache-exe.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          # A. Setup Environment
          Write-Host "Cache Miss. Starting Build Process..."
          New-Item -Path "./output" -ItemType Directory -Force | Out-Null
          
          # Trust Gallery & Install Modules
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name PS2EXE -Force -SkipPublisherCheck -Scope CurrentUser

          # B. Compile (Unsigned)
          $unsignedPath = ".\temp_unsigned.exe"
          
          Invoke-PS2EXE `
            -inputFile $env:PS1_SCRIPT_NAME `
            -outputFile $unsignedPath `
            -x64 -requireAdmin -UNICODEEncoding `
            -version "${{ steps.vars.outputs.version }}" `
            -description "Troubleshoots Helldivers 2 Issues" `
            -copyright "Â© 2025" `
            -title "Hellbomb Script" `
            -iconFile "./Bomb.ico"
            
      - name: Upload unsigned EXE
        if: steps.cache-exe.outputs.cache-hit != 'true'
        id: upload-unsigned
        uses: actions/upload-artifact@v6
        with:
          name: unsigned-exe
          path: ./temp_unsigned.exe

      - name: Submit artifact to SignPath
        if: steps.cache-exe.outputs.cache-hit != 'true'
        uses: SignPath/github-action-submit-signing-request@v2
        with:
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
          project-slug: HellbombScript
          artifact-configuration-slug: HellbombScript
          signing-policy-slug: test-signing
          github-artifact-id: ${{ steps.upload-unsigned.outputs.artifact-id }}
          wait-for-completion: true
          output-artifact-directory: "./signed-artifacts"

      - name: Extract signed EXE to output
        shell: pwsh
        run: |
          $zip = Get-ChildItem ./signed-artifacts -Filter *.zip | Select-Object -First 1
          if (-not $zip) { Throw "Signed ZIP not found in ./signed-artifacts" }
          Write-Host "Found signed ZIP: $($zip.Name)"
          $extractPath = "./signed-extracted"
          New-Item -ItemType Directory -Force -Path $extractPath | Out-Null
          Expand-Archive -Path $zip.FullName -DestinationPath $extractPath -Force
          $exe = Get-ChildItem $extractPath -Recurse -Filter *.exe | Select-Object -First 1
          if (-not $exe) { Throw "Signed EXE not found inside ZIP" }
          New-Item -ItemType Directory -Force -Path ./output | Out-Null
          Move-Item $exe.FullName "./output/${{ steps.vars.outputs.filename }}" -Force



      - name: Cleanup Files
        shell: pwsh
        run: |
          if (Test-Path ".\temp_unsigned.exe") {
            Remove-Item ".\temp_unsigned.exe" -Force
          }

      - name: Calculate Hashes
        id: hash
        shell: pwsh
        run: |
          $exePath = ".\output\${{ steps.vars.outputs.filename }}"
          $ps1Path = ".\$env:PS1_SCRIPT_NAME"

          if (-not (Test-Path $exePath)) { Throw "Signed EXE not found!" }

          $exeHash = (Get-FileHash $exePath -Algorithm SHA256).Hash
          $ps1Hash = (Get-FileHash $ps1Path -Algorithm SHA256).Hash

          Write-Output "exe_sha256=$exeHash" >> $env:GITHUB_OUTPUT
          Write-Output "ps1_sha256=$ps1Hash" >> $env:GITHUB_OUTPUT

      - name: Upload Artifact
        uses: actions/upload-artifact@v6
        with:
          name: hellbomb-exe
          path: ./output/${{ steps.vars.outputs.filename }}

  update-security-info:
    needs: build-exe
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Update SECURITY.MD
        run: |
          python .github/scripts/update_security_info.py \
            "${{ needs.build-exe.outputs.exe_hash }}" \
            "${{ needs.build-exe.outputs.exe_filename }}" \
            "${{ needs.build-exe.outputs.ps1_hash }}" \
            "${{ env.PS1_SCRIPT_NAME }}"

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b auto/security-info-update
          git add SECURITY.MD
          # Only commit if changes exist
          git diff --cached --quiet || git commit -m "docs(security): Update SECURITY.md hashes"
          git push origin auto/security-info-update --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
