name: Build Hellbomb Script EXE & Update Hashes

permissions:
  contents: write
  pull-requests: write

on:
  push:
    branches: [ main ]

env:
  SHORT_SHA: ${{ github.sha }}
  PS1_SCRIPT_NAME: "Hellbomb Script.ps1"

jobs:
  build-exe:
    runs-on: windows-latest
    outputs:
      exe_filename: ${{ steps.get_filename.outputs.final_filename }}
      exe_hash: ${{ steps.hash.outputs.exe_sha256 }}
      ps1_hash: ${{ steps.ps1_hash.outputs.ps1_sha256 }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Cache compiled EXE
        uses: actions/cache@v4
        id: exe-cache
        with:
          path: ./artifact
          key: hellbomb-exe-v3-${{ hashFiles('Hellbomb Script.ps1') }}
          restore-keys: |
            hellbomb-exe-v3-

      - name: Cache PowerShell modules
        id: ps2exe-cache
        uses: actions/cache@v4
        with:
          path: C:\Users\runneradmin\Documents\PowerShell\Modules
          key: ps2exe-modules-${{ runner.os }}-${{ hashFiles('**/*.ps1') }}
          restore-keys: |
            ps2exe-modules-${{ runner.os }}-

      - name: Install PS2EXE module
        if: steps.ps2exe-cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name PS2EXE -Force

      - name: Get version and configure filenames
        id: get_filename
        shell: pwsh
        run: |
          $scriptContent = Get-Content -Path "./${{ env.PS1_SCRIPT_NAME }}" -Raw
          if ($scriptContent -match '\|\|\s+Version\s+(\d\.\d+)') {
            $version      = $matches[1]
            $shortCommit  = "${{ env.SHORT_SHA }}".Substring(0, 7)
            
            # STABLE NAMES (used for internal caching and signing)
            $unsigned     = "Hellbomb_Script_v${version}_build.exe"
            $signed       = "Hellbomb_Script_v${version}_build-signed.exe"
            
            # FINAL NAME (used for upload/release)
            $final        = "Hellbomb_Script_v${version}-${shortCommit}-signed.exe"

            Write-Output "build_unsigned=$unsigned"       >> $env:GITHUB_OUTPUT
            Write-Output "build_signed=$signed"           >> $env:GITHUB_OUTPUT
            Write-Output "final_filename=$final"          >> $env:GITHUB_OUTPUT
            Write-Output "output_version=$version"        >> $env:GITHUB_OUTPUT
            
            Write-Host "Internal Target: $signed"
            Write-Host "Final Target:    $final"
          } else {
            Write-Error "Could not find a version number in ${{ env.PS1_SCRIPT_NAME }}."
            Exit 1
          }

      - name: Compile script to EXE (on cache miss)
        if: steps.exe-cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          if (-not (Test-Path -Path ./artifact)) { New-Item -Path ./artifact -ItemType Directory | Out-Null }
          Invoke-ps2exe `
            -inputFile "./${{ env.PS1_SCRIPT_NAME }}" `
            -outputFile "./artifact/${{ steps.get_filename.outputs.build_unsigned }}" `
            -x64 `
            -requireAdmin `
            -UNICODEEncoding `
            -version "${{ steps.get_filename.outputs.output_version }}" `
            -description "Troubleshoots Helldivers 2 Issues" `
            -copyright "Â© 2025" `
            -title "Hellbomb Script" `
            -iconFile "./Bomb.ico"

      - name: List Artifact Contents
        shell: pwsh
        run: |
          Write-Host "Checking ./artifact folder contents..."
          if (Test-Path ./artifact) {
            Get-ChildItem -Path ./artifact | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize
          } else {
            Write-Warning "./artifact folder does not exist!"
          }

      - name: Sign EXE or verify signed file
        shell: pwsh
        run: |
          $unsignedPath = "./artifact/${{ steps.get_filename.outputs.build_unsigned }}"
          $signedPath   = "./artifact/${{ steps.get_filename.outputs.build_signed }}"

          if (Test-Path $signedPath) {
            Write-Host "Signed EXE already present: $signedPath"
          } elseif (Test-Path $unsignedPath) {
            Write-Host "Signing unsigned EXE: $unsignedPath -> $signedPath"
            Install-Module -Name SignPath -Force
            Submit-SigningRequest `
              -InputArtifactPath $unsignedPath `
              -ApiToken "${{ secrets.SIGNPATH_API_TOKEN }}" `
              -OrganizationId "3279ff22-47b8-4bbf-9939-2c88ce1665ed" `
              -ProjectSlug "HellbombScript" `
              -SigningPolicySlug "test-signing" `
              -OutputArtifactPath $signedPath `
              -WaitForCompletion
            Remove-Item $unsignedPath -Force
          } else {
            Write-Error "CRITICAL: Expected files not found."
            Write-Error "Expected Unsigned: $unsignedPath"
            Write-Error "Expected Signed:   $signedPath"
            Write-Error "This usually means the cache restored files with the WRONG filenames."
            Exit 1
          }

      - name: Rename to Final Filename (with SHA)
        id: rename
        shell: pwsh
        run: |
          $cachedFile = "./artifact/${{ steps.get_filename.outputs.build_signed }}"
          $finalFile  = "./artifact/${{ steps.get_filename.outputs.final_filename }}"
          
          if (-not (Test-Path $cachedFile)) {
             Write-Error "Cannot prepare final artifact. Cached file missing: $cachedFile"
             Exit 1
          }

          Copy-Item -Path $cachedFile -Destination $finalFile -Force
          Write-Host "Prepared artifact: $finalFile"

      - name: Upload signed executable artifact
        uses: actions/upload-artifact@v5
        with:
          name: hellbomb-exe
          path: "./artifact/${{ steps.get_filename.outputs.final_filename }}"

      - name: Calculate EXE hash (signed)
        id: hash
        shell: pwsh
        run: |
          $exeFile = "./artifact/${{ steps.get_filename.outputs.final_filename }}"
          $hash = Get-FileHash $exeFile -Algorithm SHA256
          Write-Output "exe_sha256=$($hash.Hash)" >> $env:GITHUB_OUTPUT

      - name: Calculate SHA256 of PS1
        id: ps1_hash
        shell: pwsh
        run: |
          $hash = Get-FileHash "./${{ env.PS1_SCRIPT_NAME }}" -Algorithm SHA256
          Write-Output "ps1_sha256=$($hash.Hash)" >> $env:GITHUB_OUTPUT

  update-security-info:
    needs: build-exe
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Update SECURITY.MD with new hashes and links
        working-directory: ${{ github.workspace }}
        run: |
          python .github/scripts/update_security_info.py \
          "${{ needs.build-exe.outputs.exe_hash }}" \
          "${{ needs.build-exe.outputs.exe_filename }}" \
          "${{ needs.build-exe.outputs.ps1_hash }}" \
          "${{ env.PS1_SCRIPT_NAME }}"

      - name: Create and push branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b auto/security-info-update
          git add SECURITY.MD
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "docs(security): Update SECURITY.md with latest hashes"
          git push origin auto/security-info-update --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
